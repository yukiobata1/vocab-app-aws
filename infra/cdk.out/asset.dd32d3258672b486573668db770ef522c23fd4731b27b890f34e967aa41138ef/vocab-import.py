import json
import psycopg2
import boto3
import csv
import io
import base64

def lambda_handler(event, context):
    print("ЁЯЪА Starting vocabulary data import...")
    
    # Get database credentials from Secrets Manager
    secrets_client = boto3.client('secretsmanager')
    secret_arn = event['secret_arn']
    
    try:
        secret_response = secrets_client.get_secret_value(SecretId=secret_arn)
        secret = json.loads(secret_response['SecretString'])
        
        # Connect to database
        conn = psycopg2.connect(
            host=secret['host'],
            database=secret['dbname'],
            user=secret['username'],
            password=secret['password'],
            port=secret['port']
        )
        cursor = conn.cursor()
        
        # Create tables if they don't exist
        create_tables_sql = """
        -- Create vocabulary books table
        CREATE TABLE IF NOT EXISTS vocabulary_books (
            id SERIAL PRIMARY KEY,
            name VARCHAR(255) NOT NULL,
            description TEXT,
            level VARCHAR(10) NOT NULL DEFAULT 'N4',
            language_pair VARCHAR(10) NOT NULL DEFAULT 'JP-NP',
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        );

        -- Create vocabulary questions table
        CREATE TABLE IF NOT EXISTS vocabulary_questions (
            id SERIAL PRIMARY KEY,
            book_id INTEGER NOT NULL,
            ka INTEGER NOT NULL,
            np1 VARCHAR(500) NOT NULL,
            jp_kanji VARCHAR(500) NOT NULL,
            jp_rubi VARCHAR(500) NOT NULL,
            nepali_sentence TEXT DEFAULT '',
            japanese_question TEXT DEFAULT '',
            japanese_example TEXT DEFAULT '',
            extra_data JSONB DEFAULT '{}',
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            
            FOREIGN KEY (book_id) REFERENCES vocabulary_books(id) ON DELETE CASCADE
        );
        """
        
        cursor.execute(create_tables_sql)
        conn.commit()
        print("тЬЕ Tables created/verified")
        
        # Load N4 vocabulary data from embedded CSV content
        csv_content = """ka,NP1,JP-kanji,JP-rubi,NP-sentence,JP-question,exa,renban,S0,S3,S5,S7,S2,S4,N2,N4,N6,N8
1,рд╢реМрдХ,ш╢гхС│,уБЧуВЕуБ┐,рдореЗрд░реЛ рд╢реМрдХ рдЪрд▓рдЪрд┐рддреНрд░ рд╣реЗрд░реНрдиреЗ рд╣реЛ,чзБуБоя╝ИуААя╝ЙуБпуАБцШачФ╗уВТуБ┐уВЛуБУуБиуБзуБЩ,чзБуБош╢гхС│уБпуАБцШачФ╗уВТуБ┐уВЛуБУуБиуБзуБЩ,1,1
1,рдорд▓рд╛рдИ рдЪрд╛рд╕реЛ рдЫ,шИИхС│,уБНуВЗуБЖуБ┐,рдорд▓рд╛рдИ рдЬрд╛рдкрд╛рдиреА рдЪрд▓рдЪрд┐рддреНрд░рд╣рд░реВрдорд╛ рд░реБрдЪрд┐ рдЫ,цЧецЬмуБоцШачФ╗уБля╝ИуААя╝ЙуБМуБВуВКуБ╛уБЩ,цЧецЬмуБоцШачФ╗уБлшИИхС│уБМуБВуВКуБ╛уБЩ,2,1
1,рдЙрдкрдиреНрдпрд╛рд╕,х░Пшкм,уБЧуВЗуБЖуБЫуБд,рдорд▓рд╛рдИ рдЙрдкрдиреНрдпрд╛рд╕ рдорди рдкрд░реНрдЫ,чзБуБпя╝ИуААя╝ЙуБМхе╜уБНуБзуБЩ,чзБуБпх░ПшкмуБМхе╜уБНуБзуБЩ,3,1
1,рд╕рдкрдирд╛,хдв,уВЖуВБ,рднрд╡рд┐рд╖реНрдпрдХреЛ рд▓рд╛рдЧрд┐ рддрдкрд╛рдИрдВрдХреЛ рд╕рдкрдирд╛ рдХреЗ рд╣реЛ,х░ЖцЭеуБоя╝ИуААя╝ЙуБпф╜ХуБзуБЩуБЛ,х░ЖцЭеуБохдвуБпф╜ХуБзуБЩуБЛ,4,1
1,рднрд╡рд┐рд╖реНрдп,х░ЖцЭе,уБЧуВЗуБЖуВЙуБД,рдо рднрд╡рд┐рд╖реНрдпрдорд╛ рдбрд╛рдХреНрдЯрд░ рдмрдиреНрди рдЪрд╛рд╣рдиреНрдЫреБ,я╝ИуААя╝ЙуАБхМ╗шАЕуБлуБкуВКуБЯуБДуБзуБЩ,х░ЖцЭеуАБхМ╗шАЕуБлуБкуВКуБЯуБДуБзуБЩ,5,1
1,рд╕рд╡рд╛рд░реА рд╕рд╛рдзрди,ф╣ЧуВКчЙй,уБоуВКуВВуБо,рдореЗрд░реЛ рднрд╛рдЗрд▓рд╛рдИ рдХрд╛рд░ рдорди рдкрд░реНрдЫ,х╝ЯуБпя╝ИуААя╝ЙуБМхе╜уБНуБзуБЩ,х╝ЯуБпф╣ЧуВКчЙйуБМхе╜уБНуБзуБЩ,6,1
1,рдкрд╛рд░реНрдЯрдЯрд╛рдЗрдо рдХрд╛рдо,,уБВуВЛуБ░уБДуБи,рдореЗрд░реА рдмрд╣рд┐рдиреА рдПрдХ рд╕реБрдкрд░рдорд╛рд░реНрдХреЗрдЯрдорд╛ рдкрд╛рд░реНрдЯрдЯрд╛рдЗрдо рдХрд╛рдо рдЧрд░реНрдЫрд┐рдиреН,хж╣уБпуВ╣уГ╝уГСуГ╝уБзя╝ИуААя╝ЙуВТуБЧуБжуБДуБ╛уБЩ,хж╣уБпуВ╣уГ╝уГСуГ╝уБзуВвуГлуГРуВдуГИуВТуБЧуБжуБДуБ╛уБЩ,7,1
1,рд░рд╛рдореНрд░реЛ,ф╕КцЙЛуБД,уБЖуБ╛уБД,рдореЗрд░реА рдмрд╣рд┐рдиреА рдЪрд┐рддреНрд░рдХрд▓рд╛ рдорд╛ рд░рд╛рдореНрд░реЛ рдЫ,хзЙуБпч╡╡уБМя╝ИуААя╝ЙуБзуБЩ,хж╣уБпч╡╡уБМф╕КцЙЛуБДуБзуБЩ,8,1
1,рдмрд▓,хКЫ,уБбуБЛуВЙ,рдореЗрд░реЛ рднрд╛рдЗ рдореЗрд░реЛ рдмреБрдмрд╛ рднрдиреНрджрд╛ рдмрд▓рд┐рдпреЛ рдЫ,хЕДуБпчИ╢уВИуВКя╝ИуААя╝ЙуБМх╝╖уБДуБзуБЩ,хЕДуБпчИ╢уВИуВКхКЫуБМх╝╖уБДуБзуБЩ,9,1
1,рд╕реЗрддреЛ,чЩ╜уБД,уБЧуВНуБД,рдпреЛ рдХрд╛рдЧрдЬ рд╕реЗрддреЛ рдЫ,уБУуБоч┤ЩуБпя╝ИуААя╝ЙуБзуБЩ,уБУуБоч┤ЩуБпчЩ╜уБДуБзуБЩ,10,1
2,рд╡рд░реНрд╖рд╛,щЫи,уБВуВБ,рд╣рд┐рдЬреЛ рдзреЗрд░реИ рд╡рд░реНрд╖рд╛ рднрдпреЛ,цШицЧея╝ИуААя╝ЙуБМуБЯуБПуБХуВУщЩНуВКуБ╛уБЧуБЯ,цШицЧещЫиуБМуБЯуБПуБХуВУщЩНуВКуБ╛уБЧуБЯ,11,1
2,рд╣рд╛рд╡рд╛,щви,уБЛуБЬ,рдЖрдЬ рдмрд┐рд╣рд╛рди рдЪрд┐рд╕реЛ рд╣рд╛рд╡рд╛ рдЪрд▓рд┐рд░рд╣реЗрдХреЛ рдЫ,ф╗КцЬЭя╝ИуААя╝ЙуБМхЖ╖уБЯуБДуБзуБЩ,ф╗КцЬЭщвиуБМхЖ╖уБЯуБДуБзуБЩ,12,1
2,рдЖрдХрд╛рд╢,чй║,уБЭуВЙ,рдЖрдЬрдХреЛ рдЖрдХрд╛рд╢ рдиреАрд▓реЛ рдЫ,ф╗КцЧеуБоя╝ИуААя╝ЙуБпщЭТуБДуБзуБЩ,ф╗КцЧеуБочй║уБпщЭТуБДуБзуБЩ,13,1
2,рдкрд╣рд╛рдб,х▒▒,уВДуБ╛,рдиреЗрдкрд╛рд▓рдорд╛ рдзреЗрд░реИ рдЕрдЧреНрд▓реЛ рдкрд╣рд╛рдбрд╣рд░реВ рдЫрдиреН,уГНуГСуГ╝уГлуБлуБпщлШуБДя╝ИуААя╝ЙуБМуБЯуБПуБХуВУуБВуВКуБ╛уБЩ,уГНуГСуГ╝уГлуБлуБпщлШуБДх▒▒уБМуБЯуБПуБХуВУуБВуВКуБ╛уБЩ,14,1
2,рд╕рдореБрджреНрд░,ц╡╖,уБЖуБ┐,рдЬрд╛рдкрд╛рдирдорд╛ рд╕рдореБрджреНрд░ рдЫ,цЧецЬмуБлуБпя╝ИуААя╝ЙуБМуБВуВКуБ╛уБЩ,цЧецЬмуБлуБпц╡╖уБМуБВуВКуБ╛уБЩ,15,1
2,рдирджреА,х╖Э,уБЛуВП,рдпрд╣рд╛рдБ рдПрдХ рд╕рд╛рдиреЛ рдирджреА рдЫ,уБУуБУуБлх░ПуБХуБкя╝ИуААя╝ЙуБМуБВуВКуБ╛уБЩ,уБУуБУуБлх░ПуБХуБкх╖ЭуБМуБВуВКуБ╛уБЩ,16,1
2,рддрд╛рд▓,ц╣Ц,уБ┐уБЪуБЖуБ┐,рдлреБрдЬреА рдкрд╣рд╛рдбрдХреЛ рдирдЬрд┐рдХ рдкрд╛рдБрдЪ рддрд╛рд▓ рдЫрдиреН,хпМхглх▒▒уБош┐СуБПуБлф║ФуБдуБоя╝ИуААя╝ЙуБМуБВуВКуБ╛уБЩ,хпМхглх▒▒уБош┐СуБПуБлф║ФуБдуБоц╣ЦуБМуБВуВКуБ╛уБЩ,17,1
2,рдмрдЧреИрдБрдЪрд╛,х║н,уБлуВП,рд╣рд╛рдореНрд░реЛ рдШрд░рдХреЛ рдмрдЧреИрдБрдЪрд╛рдорд╛ рдлреВрд▓рд╣рд░реВ рдЫрдиреН,чзБуБЯуБбуБохо╢уБоя╝ИуААя╝ЙуБлшК▒уБМуБВуВКуБ╛уБЩ,чзБуБЯуБбуБохо╢уБох║нуБлшК▒уБМуБВуВКуБ╛уБЩ,18,1
2,рд░реВрдЦ,цЬи,уБН,рдмрдЧреИрдБрдЪрд╛рдорд╛ рдареВрд▓реЛ рд░реВрдЦ рдЫ,х║нуБлхдзуБНуБкя╝ИуААя╝ЙуБМуБВуВКуБ╛уБЩ,х║нуБлхдзуБНуБкцЬиуБМуБВуВКуБ╛уБЩ,19,1
2,рдлреВрд▓,шК▒,уБпуБк,рдЧреБрд▓рд╛рдмрдХреЛ рдлреВрд▓ рд╕реБрдиреНрджрд░ рдЫ,уГРуГйуБоя╝ИуААя╝ЙуБпч╛ОуБЧуБДуБзуБЩ,уГРуГйуБошК▒уБпч╛ОуБЧуБДуБзуБЩ,20,1
3,рдШрд░,хо╢,уБДуБИ,рдореЗрд░реЛ рдШрд░ рд╕реНрдЯреЗрд╢рдирдХреЛ рдирдЬрд┐рдХ рдЫ,чзБуБоя╝ИуААя╝ЙуБпщзЕуБош┐СуБПуБзуБЩ,чзБуБохо╢уБпщзЕуБош┐СуБПуБзуБЩ,21,1
3,рдХреЛрдард╛,щГих▒Л,уБ╕уВД,рдпреЛ рдХреЛрдард╛ рдареВрд▓реЛ рдЫ,уБУуБоя╝ИуААя╝ЙуБпхдзуБНуБДуБзуБЩ,уБУуБощГих▒ЛуБпхдзуБНуБДуБзуБЩ,22,1
3,рднрд╛рдиреНрд╕рд╛,хП░цЙА,уБауБДуБйуБУуВН,рдЖрдорд╛ рднрд╛рдиреНрд╕рд╛рдорд╛ рдЦрд╛рдирд╛ рдкрдХрд╛рдЙрдиреБрд╣реБрдиреНрдЫ,цпНуБпя╝ИуААя╝ЙуБзцЦЩчРЖуБЧуБ╛уБЩ,цпНуБпхП░цЙАуБзцЦЩчРЖуБЧуБ╛уБЩ,23,1
3,рд╢рдпрдирдХрдХреНрд╖,хпЭход,уБЧуВУуБЧуБд,рдореЗрд░реЛ рд╢рдпрдирдХрдХреНрд╖рдорд╛ рдХрд┐рддрд╛рдмрд╣рд░реВ рдЫрдиреН,чзБуБоя╝ИуААя╝ЙуБлцЬмуБМуБВуВКуБ╛уБЩ,чзБуБохпЭходуБлцЬмуБМуБВуВКуБ╛уБЩ,24,1
3,рдмреИрдардХ рдХрдХреНрд╖,х▒ЕщЦУ,уБДуБ╛,рдмреИрдардХ рдХрдХреНрд╖рдорд╛ рдЯреЗрд▓рд┐рднрд┐рдЬрди рдЫ,я╝ИуААя╝ЙуБлуГЖуГмуГУуБМуБВуВКуБ╛уБЩ,х▒ЕщЦУуБлуГЖуГмуГУуБМуБВуВКуБ╛уБЩ,25,1
3,рдмрд╛рдерд░реВрдо,щвихСВ,уБ╡уВН,рдо рд╣рд░реЗрдХ рджрд┐рди рдмрд╛рдерд░реВрдо рдЧрд░реНрдЫреБ,чзБуБпцпОцЧея╝ИуААя╝ЙуБлхЕеуВКуБ╛уБЩ,чзБуБпцпОцЧещвихСВуБлхЕеуВКуБ╛уБЩ,26,1
3,рд╢реМрдЪрд╛рд▓рдп,уБКцЙЛц┤ЧуБД,уБКуБжуБВуВЙуБД,рд╢реМрдЪрд╛рд▓рдп рджреЛрд╕реНрд░реЛ рддрд▓рд╛рдорд╛ рдЫ,я╝ИуААя╝ЙуБпф║МщЪОуБлуБВуВКуБ╛уБЩ,уБКцЙЛц┤ЧуБДуБпф║МщЪОуБлуБВуВКуБ╛уБЩ,27,1
3,рдвреЛрдХрд╛,уГЙуВв,уБйуБВ,рдХреГрдкрдпрд╛ рдвреЛрдХрд╛ рдмрдиреНрдж рдЧрд░реНрдиреБрд╣реЛрд╕реН,я╝ИуААя╝ЙуВТщЦЙуВБуБжуБПуБауБХуБД,уГЙуВвуВТщЦЙуВБуБжуБПуБауБХуБД,28,1
3,рдЭреНрдпрд╛рд▓,чкУ,уБ╛уБй,рдЭреНрдпрд╛рд▓ рдЦреЛрд▓реНрдиреБрд╣реЛрд╕реН,я╝ИуААя╝ЙуВТщЦЛуБСуБжуБПуБауБХуБД,чкУуВТщЦЛуБСуБжуБПуБауБХуБД,29,1
3,рдкрд░реНрджрд╛,уВлуГ╝уГЖуГ│,уБЛуГ╝уБжуВУ,рдХреЛрдард╛рдорд╛ рд░рд╛рддреЛ рдкрд░реНрджрд╛ рдЫ,щГих▒ЛуБлш╡дуБДя╝ИуААя╝ЙуБМуБВуВКуБ╛уБЩ,щГих▒ЛуБлш╡дуБДуВлуГ╝уГЖуГ│уБМуБВуВКуБ╛уБЩ,30,1
4,рд╕реНрдХреВрд▓,хнжцаб,уБМуБгуБУуБЖ,рдо рд╣рд░реЗрдХ рджрд┐рди рд╕реНрдХреВрд▓ рдЬрд╛рдиреНрдЫреБ,чзБуБпцпОцЧея╝ИуААя╝ЙуБлшбМуБНуБ╛уБЩ,чзБуБпцпОцЧехнжцабуБлшбМуБНуБ╛уБЩ,31,1
4,рдХрдХреНрд╖рд╛,цХЩход,уБНуВЗуБЖуБЧуБд,рд╣рд╛рдореНрд░реЛ рдХрдХреНрд╖рд╛рдорд╛ рейреж рдЬрдирд╛ рд╡рд┐рджреНрдпрд╛рд░реНрдереА рдЫрдиреН,чзБуБЯуБбуБоя╝ИуААя╝ЙуБл30ф║║уБохнжчФЯуБМуБДуБ╛уБЩ,чзБуБЯуБбуБоцХЩходуБл30ф║║уБохнжчФЯуБМуБДуБ╛уБЩ,32,1
4,рд╢рд┐рдХреНрд╖рдХ,хЕИчФЯ,уБЫуВУуБЫуБД,рд╢рд┐рдХреНрд╖рдХ рдзреЗрд░реИ рджрдпрд╛рд▓реБ рд╣реБрдиреБрд╣реБрдиреНрдЫ,я╝ИуААя╝ЙуБпуБиуБжуВВшжкхИЗуБзуБЩ,хЕИчФЯуБпуБиуБжуВВшжкхИЗуБзуБЩ,33,1
4,рд╡рд┐рджреНрдпрд╛рд░реНрдереА,хнжчФЯ,уБМуБПуБЫуБД,рдЙрд╣рд╛рдБ рдЬрд╛рдкрд╛рдиреА рднрд╛рд╖рд╛рдХрд╛ рд╡рд┐рджреНрдпрд╛рд░реНрдереА рд╣реБрдиреБрд╣реБрдиреНрдЫ,х╜╝уБпцЧецЬмшкЮуБоя╝ИуААя╝ЙуБзуБЩ,х╜╝уБпцЧецЬмшкЮуБохнжчФЯуБзуБЩ,34,1
4,рдЕрдзреНрдпрдпрди,хЛЙх╝╖,уБ╣уВУуБНуВЗуБЖ,рдо рд╣рд░реЗрдХ рджрд┐рди рдЬрд╛рдкрд╛рдиреА рднрд╛рд╖рд╛рдХреЛ рдЕрдзреНрдпрдпрди рдЧрд░реНрдЫреБ,чзБуБпцпОцЧецЧецЬмшкЮуВТя╝ИуААя╝ЙуБЧуБ╛уБЩ,чзБуБпцпОцЧецЧецЬмшкЮуВТхЛЙх╝╖уБЧуБ╛уБЩ,35,1
4,рдкрд░реАрдХреНрд╖рд╛,шйжщиУ,уБЧуБСуВУ,рднреЛрд▓рд┐ рдЬрд╛рдкрд╛рдиреА рднрд╛рд╖рд╛рдХреЛ рдкрд░реАрдХреНрд╖рд╛ рдЫ,цШОцЧецЧецЬмшкЮуБоя╝ИуААя╝ЙуБМуБВуВКуБ╛уБЩ,цШОцЧецЧецЬмшкЮуБошйжщиУуБМуБВуВКуБ╛уБЩ,36,1
4,рдЧреГрд╣рдХрд╛рд░реНрдп,хо┐щбМ,уБЧуВЕуБПуБауБД,рдорд▓рд╛рдИ рдЧреГрд╣рдХрд╛рд░реНрдп рдЧрд░реНрди рдорди рдкрд░реНрджреИрди,я╝ИуААя╝ЙуВТуБЩуВЛуБоуБМхлМуБДуБзуБЩ,хо┐щбМуВТуБЩуВЛуБоуБМхлМуБДуБзуБЩ,37,1
4,рдХрд┐рддрд╛рдм,цЬм,уБ╗уВУ,рдпреЛ рдХрд┐рддрд╛рдм рдзреЗрд░реИ рд░реЛрдЪрдХ рдЫ,уБУуБоя╝ИуААя╝ЙуБпуБиуБжуВВщЭвчЩ╜уБДуБзуБЩ,уБУуБоцЬмуБпуБиуБжуВВщЭвчЩ╜уБДуБзуБЩ,38,1
4,рдиреЛрдЯрдмреБрдХ,уГОуГ╝уГИ,уБоуГ╝уБи,рдХреГрдкрдпрд╛ рдиреЛрдЯрдмреБрдХрдорд╛ рд▓реЗрдЦреНрдиреБрд╣реЛрд╕реН,я╝ИуААя╝ЙуБлцЫ╕уБДуБжуБПуБауБХуБД,уГОуГ╝уГИуБлцЫ╕уБДуБжуБПуБауБХуБД,39,1
4,рдХрд▓рдо,уГЪуГ│,уБ║уВУ,рдпреЛ рдХрд▓рдо рд░рд╛рдореНрд░реЛ рдЫ,уБУуБоя╝ИуААя╝ЙуБпуБДуБДуБзуБЩ,уБУуБоуГЪуГ│уБпуБДуБДуБзуБЩ,40,1
5,рдХрд╛рдо,ф╗Хф║Л,уБЧуБФуБи,рдореЗрд░реЛ рдмреБрдмрд╛рдХреЛ рдХрд╛рдо рдЕрд╕реНрдкрддрд╛рд▓рдорд╛ рдЫ,чИ╢уБоя╝ИуААя╝ЙуБпчЧЕщЩвуБзуБЩ,чИ╢уБоф╗Хф║ЛуБпчЧЕщЩвуБзуБЩ,41,1
5,рдХрдореНрдкрдиреА,ф╝Ъчд╛,уБЛуБДуБЧуВГ,рдЙрд╣рд╛рдБ рдареВрд▓реЛ рдХрдореНрдкрдиреАрдорд╛ рдХрд╛рдо рдЧрд░реНрдиреБрд╣реБрдиреНрдЫ,х╜╝уБпхдзуБНуБкя╝ИуААя╝ЙуБзхГНуБДуБжуБДуБ╛уБЩ,х╜╝уБпхдзуБНуБкф╝Ъчд╛уБзхГНуБДуБжуБДуБ╛уБЩ,42,1
5,рдХрд╛рд░реНрдпрд╛рд▓рдп,ф║ЛхЛЩцЙА,уБШуВАуБЧуВЗ,рдореЗрд░реЛ рдХрд╛рд░реНрдпрд╛рд▓рдп рдЯреЛрдХрд┐рдпреЛрдорд╛ рдЫ,чзБуБоя╝ИуААя╝ЙуБпцЭ▒ф║муБлуБВуВКуБ╛уБЩ,чзБуБоф║ЛхЛЩцЙАуБпцЭ▒ф║муБлуБВуВКуБ╛уБЩ,43,1
5,рдмреИрдВрдХ,щКАшбМ,уБОуВУуБУуБЖ,рдо рдмреИрдВрдХрдорд╛ рдХрд╛рдо рдЧрд░реНрдЫреБ,чзБуБпя╝ИуААя╝ЙуБзхГНуБДуБжуБДуБ╛уБЩ,чзБуБпщКАшбМуБзхГНуБДуБжуБДуБ╛уБЩ,44,1
5,рдбрд╛рдХреНрдЯрд░,хМ╗шАЕ,уБДуБЧуВГ,рдореЗрд░реА рдЖрдорд╛ рдбрд╛рдХреНрдЯрд░ рд╣реБрдиреБрд╣реБрдиреНрдЫ,цпНуБпя╝ИуААя╝ЙуБзуБЩ,цпНуБпхМ╗шАЕуБзуБЩ,45,1
5,рдирд░реНрд╕,чЬЛшн╖х╕л,уБЛуВУуБФуБЧ,рдЕрд╕реНрдкрддрд╛рд▓рдорд╛ рдзреЗрд░реИ рдирд░реНрд╕рд╣рд░реВ рдЫрдиреН,чЧЕщЩвуБлуБЯуБПуБХуВУуБоя╝ИуААя╝ЙуБМуБДуБ╛уБЩ,чЧЕщЩвуБлуБЯуБПуБХуВУуБочЬЛшн╖х╕луБМуБДуБ╛уБЩ,46,1
5,рд╢рд┐рдХреНрд╖рдХ,цХЩх╕л,уБНуВЗуБЖуБЧ,рдЙрд╣рд╛рдБ рдорд╛рдзреНрдпрдорд┐рдХ рд╡рд┐рджреНрдпрд╛рд▓рдпрдХрд╛ рд╢рд┐рдХреНрд╖рдХ рд╣реБрдиреБрд╣реБрдиреНрдЫ,х╜╝уБпф╕нхнжцабуБоя╝ИуААя╝ЙуБзуБЩ,х╜╝уБпф╕нхнжцабуБоцХЩх╕луБзуБЩ,47,1
5,рдЗрдиреНрдЬрд┐рдирд┐рдпрд░,уВиуГ│уВ╕уГЛуВв,уБИуВУуБШуБлуБВ,рдореЗрд░реЛ рджрд╛рдЬреБ рдЗрдиреНрдЬрд┐рдирд┐рдпрд░ рд╣реБрдиреБрд╣реБрдиреНрдЫ,хЕДуБпя╝ИуААя╝ЙуБзуБЩ,хЕДуБпуВиуГ│уВ╕уГЛуВвуБзуБЩ,48,1
5,рд╡реНрдпрд╛рдкрд╛рд░реА,хХЖф║║,уБЧуВЗуБЖуБлуВУ,рдЙрд╣рд╛рдБ рд╕рдлрд▓ рд╡реНрдпрд╛рдкрд╛рд░реА рд╣реБрдиреБрд╣реБрдиреНрдЫ,х╜╝уБпцИРхКЯуБЧуБЯя╝ИуААя╝ЙуБзуБЩ,х╜╝уБпцИРхКЯуБЧуБЯхХЖф║║уБзуБЩ,49,1
5,рдЪрд╛рд▓рдХ,щБЛш╗вцЙЛ,уБЖуВУуБжуВУуБЧуВЕ,рдЙрд╣рд╛рдБ рдЯреНрдпрд╛рдХреНрд╕реАрдХреЛ рдЪрд╛рд▓рдХ рд╣реБрдиреБрд╣реБрдиреНрдЫ,х╜╝уБпуВ┐уВпуВ╖уГ╝уБоя╝ИуААя╝ЙуБзуБЩ,х╜╝уБпуВ┐уВпуВ╖уГ╝уБощБЛш╗вцЙЛуБзуБЩ,50,1"""
        
        # Parse CSV data
        csv_reader = csv.DictReader(io.StringIO(csv_content))
        n4_vocab_data = list(csv_reader)
        
        # Insert N4 vocabulary book
        cursor.execute("""
            INSERT INTO vocabulary_books (name, description, level, language_pair)
            VALUES (%s, %s, %s, %s)
            ON CONFLICT DO NOTHING
            RETURNING id
        """, ("N4шкЮх╜Щ", "JLPT N4уГмуГЩуГлуБошкЮх╜ЩщЫЖя╝ИцЧецЬмшкЮуГ╗уГНуГСуГ╝уГлшкЮхп╛чЕзя╝Й", "N4", "JP-NP"))
        
        result = cursor.fetchone()
        if result:
            n4_book_id = result[0]
        else:
            cursor.execute("SELECT id FROM vocabulary_books WHERE name = %s", ("N4шкЮх╜Щ",))
            n4_book_id = cursor.fetchone()[0]
        
        # Clear existing questions for this book to avoid duplicates
        cursor.execute("DELETE FROM vocabulary_questions WHERE book_id = %s", (n4_book_id,))
        
        # Insert N4 vocabulary questions from CSV data
        inserted_count = 0
        for row in n4_vocab_data:
            cursor.execute("""
                INSERT INTO vocabulary_questions (
                    book_id, ka, np1, jp_kanji, jp_rubi,
                    nepali_sentence, japanese_question, japanese_example
                ) VALUES (%s, %s, %s, %s, %s, %s, %s, %s)
            """, (
                n4_book_id,
                int(row['ka']) if row['ka'] else 1,
                row['NP1'] or '',
                row['JP-kanji'] or '',
                row['JP-rubi'] or '',
                row['NP-sentence'] or '',
                row['JP-question'] or '',
                row['exa'] or ''
            ))
            inserted_count += 1
        
        conn.commit()
        
        # Get stats
        cursor.execute("SELECT COUNT(*) FROM vocabulary_books")
        book_count = cursor.fetchone()[0]
        
        cursor.execute("SELECT COUNT(*) FROM vocabulary_questions")
        question_count = cursor.fetchone()[0]
        
        conn.close()
        
        print(f"тЬЕ Data import completed: {inserted_count} questions inserted")
        
        return {
            'statusCode': 200,
            'body': json.dumps({
                'message': 'Vocabulary data imported successfully',
                'books': book_count,
                'questions': question_count,
                'inserted': inserted_count
            })
        }
        
    except Exception as e:
        print(f"тЭМ Error: {str(e)}")
        return {
            'statusCode': 500,
            'body': json.dumps({
                'error': str(e)
            })
        }