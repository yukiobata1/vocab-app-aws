"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.HotswapMockSdkProvider = exports.stackSummaryOf = exports.addTemplateToCloudFormationLookupMock = exports.setCurrentCfnStackTemplate = exports.pushNestedStackResourceSummaries = exports.pushStackResourceSummaries = exports.cdkStackArtifactOf = exports.setupHotswapNestedStackTests = exports.setupHotswapTests = exports.STACK_ID = void 0;
const common_1 = require("../../../lib/api/hotswap/common");
const deployments = require("../../../lib/api/hotswap-deployments");
const cloudformation_1 = require("../../../lib/api/util/cloudformation");
const util_1 = require("../../util");
const mock_sdk_1 = require("../../util/mock-sdk");
const fake_cloudformation_stack_1 = require("../fake-cloudformation-stack");
const STACK_NAME = 'withouterrors';
exports.STACK_ID = 'stackId';
let hotswapMockSdkProvider;
let currentCfnStack;
const currentCfnStackResources = [];
let stackTemplates;
let currentNestedCfnStackResources;
function setupHotswapTests() {
    jest.resetAllMocks();
    // clear the array
    currentCfnStackResources.splice(0);
    hotswapMockSdkProvider = new HotswapMockSdkProvider();
    currentCfnStack = new fake_cloudformation_stack_1.FakeCloudformationStack({
        stackName: STACK_NAME,
        stackId: exports.STACK_ID,
    });
    cloudformation_1.CloudFormationStack.lookup = async (_, _stackName) => {
        return currentCfnStack;
    };
    return hotswapMockSdkProvider;
}
exports.setupHotswapTests = setupHotswapTests;
function setupHotswapNestedStackTests(rootStackName) {
    jest.resetAllMocks();
    currentNestedCfnStackResources = {};
    hotswapMockSdkProvider = new HotswapMockSdkProvider(rootStackName);
    currentCfnStack = new fake_cloudformation_stack_1.FakeCloudformationStack({
        stackName: rootStackName,
        stackId: exports.STACK_ID,
    });
    stackTemplates = {};
    cloudformation_1.CloudFormationStack.lookup = async (_, stackName) => {
        currentCfnStack.template = async () => stackTemplates[stackName];
        return currentCfnStack;
    };
    return hotswapMockSdkProvider;
}
exports.setupHotswapNestedStackTests = setupHotswapNestedStackTests;
function cdkStackArtifactOf(testStackArtifact = {}) {
    return (0, util_1.testStack)({
        stackName: STACK_NAME,
        ...testStackArtifact,
    });
}
exports.cdkStackArtifactOf = cdkStackArtifactOf;
function pushStackResourceSummaries(...items) {
    currentCfnStackResources.push(...items);
}
exports.pushStackResourceSummaries = pushStackResourceSummaries;
function pushNestedStackResourceSummaries(stackName, ...items) {
    if (!currentNestedCfnStackResources[stackName]) {
        currentNestedCfnStackResources[stackName] = [];
    }
    currentNestedCfnStackResources[stackName].push(...items);
}
exports.pushNestedStackResourceSummaries = pushNestedStackResourceSummaries;
function setCurrentCfnStackTemplate(template) {
    const templateDeepCopy = JSON.parse(JSON.stringify(template)); // deep copy the template, so our tests can mutate one template instead of creating two
    currentCfnStack.setTemplate(templateDeepCopy);
}
exports.setCurrentCfnStackTemplate = setCurrentCfnStackTemplate;
function addTemplateToCloudFormationLookupMock(stackArtifact) {
    const templateDeepCopy = JSON.parse(JSON.stringify(stackArtifact.template)); // deep copy the template, so our tests can mutate one template instead of creating two
    stackTemplates[stackArtifact.stackName] = templateDeepCopy;
}
exports.addTemplateToCloudFormationLookupMock = addTemplateToCloudFormationLookupMock;
function stackSummaryOf(logicalId, resourceType, physicalResourceId) {
    return {
        LogicalResourceId: logicalId,
        PhysicalResourceId: physicalResourceId,
        ResourceType: resourceType,
        ResourceStatus: 'CREATE_COMPLETE',
        LastUpdatedTimestamp: new Date(),
    };
}
exports.stackSummaryOf = stackSummaryOf;
class HotswapMockSdkProvider {
    constructor(rootStackName) {
        this.mockSdkProvider = new mock_sdk_1.MockSdkProvider({ realSdk: false });
        this.mockSdkProvider.stubCloudFormation({
            listStackResources: ({ StackName: stackName }) => {
                if (rootStackName) {
                    const knownStackNames = Object.keys(currentNestedCfnStackResources);
                    if (stackName !== rootStackName && !knownStackNames.includes(stackName)) {
                        throw new Error(`Expected Stack name in listStackResources() call to be a member of ['${rootStackName}, ${knownStackNames}'], but received: '${stackName}'`);
                    }
                }
                else if (stackName !== STACK_NAME) {
                    throw new Error(`Expected Stack name in listStackResources() call to be: '${STACK_NAME}', but received: '${stackName}'`);
                }
                return {
                    StackResourceSummaries: rootStackName ? currentNestedCfnStackResources[stackName] : currentCfnStackResources,
                };
            },
        });
    }
    setUpdateStateMachineMock(mockUpdateMachineDefinition) {
        this.mockSdkProvider.stubStepFunctions({
            updateStateMachine: mockUpdateMachineDefinition,
        });
    }
    stubLambda(stubs, serviceStubs, additionalProperties = {}) {
        this.mockSdkProvider.stubLambda(stubs, {
            api: {
                waiters: {},
            },
            makeRequest() {
                return {
                    promise: () => Promise.resolve({}),
                    response: {},
                    addListeners: () => { },
                };
            },
            ...serviceStubs,
            ...additionalProperties,
        });
    }
    getLambdaApiWaiters() {
        return this.mockSdkProvider.sdk.lambda().api.waiters;
    }
    setUpdateProjectMock(mockUpdateProject) {
        this.mockSdkProvider.stubCodeBuild({
            updateProject: mockUpdateProject,
        });
    }
    stubAppSync(stubs) {
        this.mockSdkProvider.stubAppSync(stubs);
    }
    setInvokeLambdaMock(mockInvokeLambda) {
        this.mockSdkProvider.stubLambda({
            invoke: mockInvokeLambda,
        });
    }
    stubEcs(stubs, additionalProperties = {}) {
        this.mockSdkProvider.stubEcs(stubs, additionalProperties);
    }
    stubGetEndpointSuffix(stub) {
        this.mockSdkProvider.stubGetEndpointSuffix(stub);
    }
    stubS3(stubs) {
        this.mockSdkProvider.stubS3(stubs);
    }
    tryHotswapDeployment(hotswapMode, stackArtifact, assetParams = {}, hotswapPropertyOverrides) {
        let hotswapProps = hotswapPropertyOverrides || new common_1.HotswapPropertyOverrides();
        return deployments.tryHotswapDeployment(this.mockSdkProvider, assetParams, currentCfnStack, stackArtifact, hotswapMode, hotswapProps);
    }
}
exports.HotswapMockSdkProvider = HotswapMockSdkProvider;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaG90c3dhcC10ZXN0LXNldHVwLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiaG90c3dhcC10ZXN0LXNldHVwLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQU1BLDREQUF3RjtBQUN4RixvRUFBb0U7QUFDcEUseUVBQXFGO0FBQ3JGLHFDQUEwRDtBQUMxRCxrREFBMkU7QUFDM0UsNEVBQXVFO0FBRXZFLE1BQU0sVUFBVSxHQUFHLGVBQWUsQ0FBQztBQUN0QixRQUFBLFFBQVEsR0FBRyxTQUFTLENBQUM7QUFFbEMsSUFBSSxzQkFBOEMsQ0FBQztBQUNuRCxJQUFJLGVBQXdDLENBQUM7QUFDN0MsTUFBTSx3QkFBd0IsR0FBOEMsRUFBRSxDQUFDO0FBQy9FLElBQUksY0FBNEMsQ0FBQztBQUNqRCxJQUFJLDhCQUFrRyxDQUFDO0FBRXZHLFNBQWdCLGlCQUFpQjtJQUMvQixJQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7SUFDckIsa0JBQWtCO0lBQ2xCLHdCQUF3QixDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUNuQyxzQkFBc0IsR0FBRyxJQUFJLHNCQUFzQixFQUFFLENBQUM7SUFDdEQsZUFBZSxHQUFHLElBQUksbURBQXVCLENBQUM7UUFDNUMsU0FBUyxFQUFFLFVBQVU7UUFDckIsT0FBTyxFQUFFLGdCQUFRO0tBQ2xCLENBQUMsQ0FBQztJQUNILG9DQUFtQixDQUFDLE1BQU0sR0FBRyxLQUFLLEVBQUUsQ0FBcUIsRUFBRSxVQUFrQixFQUFFLEVBQUU7UUFDL0UsT0FBTyxlQUFlLENBQUM7SUFDekIsQ0FBQyxDQUFDO0lBRUYsT0FBTyxzQkFBc0IsQ0FBQztBQUNoQyxDQUFDO0FBZEQsOENBY0M7QUFFRCxTQUFnQiw0QkFBNEIsQ0FBQyxhQUFxQjtJQUNoRSxJQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7SUFDckIsOEJBQThCLEdBQUcsRUFBRSxDQUFDO0lBQ3BDLHNCQUFzQixHQUFHLElBQUksc0JBQXNCLENBQUMsYUFBYSxDQUFD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IGZyb20gJ0Bhd3MtY2RrL2N4LWFwaSc7XG5pbXBvcnQgKiBhcyBBV1MgZnJvbSAnYXdzLXNkayc7XG5pbXBvcnQgKiBhcyBjb2RlYnVpbGQgZnJvbSAnYXdzLXNkay9jbGllbnRzL2NvZGVidWlsZCc7XG5pbXBvcnQgKiBhcyBsYW1iZGEgZnJvbSAnYXdzLXNkay9jbGllbnRzL2xhbWJkYSc7XG5pbXBvcnQgKiBhcyBzdGVwZnVuY3Rpb25zIGZyb20gJ2F3cy1zZGsvY2xpZW50cy9zdGVwZnVuY3Rpb25zJztcbmltcG9ydCB7IERlcGxveVN0YWNrUmVzdWx0IH0gZnJvbSAnLi4vLi4vLi4vbGliL2FwaSc7XG5pbXBvcnQgeyBIb3Rzd2FwTW9kZSwgSG90c3dhcFByb3BlcnR5T3ZlcnJpZGVzIH0gZnJvbSAnLi4vLi4vLi4vbGliL2FwaS9ob3Rzd2FwL2NvbW1vbic7XG5pbXBvcnQgKiBhcyBkZXBsb3ltZW50cyBmcm9tICcuLi8uLi8uLi9saWIvYXBpL2hvdHN3YXAtZGVwbG95bWVudHMnO1xuaW1wb3J0IHsgQ2xvdWRGb3JtYXRpb25TdGFjaywgVGVtcGxhdGUgfSBmcm9tICcuLi8uLi8uLi9saWIvYXBpL3V0aWwvY2xvdWRmb3JtYXRpb24nO1xuaW1wb3J0IHsgdGVzdFN0YWNrLCBUZXN0U3RhY2tBcnRpZmFjdCB9IGZyb20gJy4uLy4uL3V0aWwnO1xuaW1wb3J0IHsgTW9ja1Nka1Byb3ZpZGVyLCBTeW5jSGFuZGxlclN1YnNldE9mIH0gZnJvbSAnLi4vLi4vdXRpbC9tb2NrLXNkayc7XG5pbXBvcnQgeyBGYWtlQ2xvdWRmb3JtYXRpb25TdGFjayB9IGZyb20gJy4uL2Zha2UtY2xvdWRmb3JtYXRpb24tc3RhY2snO1xuXG5jb25zdCBTVEFDS19OQU1FID0gJ3dpdGhvdXRlcnJvcnMnO1xuZXhwb3J0IGNvbnN0IFNUQUNLX0lEID0gJ3N0YWNrSWQnO1xuXG5sZXQgaG90c3dhcE1vY2tTZGtQcm92aWRlcjogSG90c3dhcE1vY2tTZGtQcm92aWRlcjtcbmxldCBjdXJyZW50Q2ZuU3RhY2s6IEZha2VDbG91ZGZvcm1hdGlvblN0YWNrO1xuY29uc3QgY3VycmVudENmblN0YWNrUmVzb3VyY2VzOiBBV1MuQ2xvdWRGb3JtYXRpb24uU3RhY2tSZXNvdXJjZVN1bW1hcnlbXSA9IFtdO1xubGV0IHN0YWNrVGVtcGxhdGVzOiB7IFtzdGFja05hbWU6IHN0cmluZ106IGFueSB9O1xubGV0IGN1cnJlbnROZXN0ZWRDZm5TdGFja1Jlc291cmNlczogeyBbc3RhY2tOYW1lOiBzdHJpbmddOiBBV1MuQ2xvdWRGb3JtYXRpb24uU3RhY2tSZXNvdXJjZVN1bW1hcnlbXSB9O1xuXG5leHBvcnQgZnVuY3Rpb24gc2V0dXBIb3Rzd2FwVGVzdHMoKTogSG90c3dhcE1vY2tTZGtQcm92aWRlciB7XG4gIGplc3QucmVzZXRBbGxNb2NrcygpO1xuICAvLyBjbGVhciB0aGUgYXJyYXlcbiAgY3VycmVudENmblN0YWNrUmVzb3VyY2VzLnNwbGljZSgwKTtcbiAgaG90c3dhcE1vY2tTZGtQcm92aWRlciA9IG5ldyBIb3Rzd2FwTW9ja1Nka1Byb3ZpZGVyKCk7XG4gIGN1cnJlbnRDZm5TdGFjayA9IG5ldyBGYWtlQ2xvdWRmb3JtYXRpb25TdGFjayh7XG4gICAgc3RhY2tOYW1lOiBTVEFDS19OQU1FLFxuICAgIHN0YWNrSWQ6IFNUQUNLX0lELFxuICB9KTtcbiAgQ2xvdWRGb3JtYXRpb25TdGFjay5sb29rdXAgPSBhc3luYyAoXzogQVdTLkNsb3VkRm9ybWF0aW9uLCBfc3RhY2tOYW1lOiBzdHJpbmcpID0+IHtcbiAgICByZXR1cm4gY3VycmVudENmblN0YWNrO1xuICB9O1xuXG4gIHJldHVybiBob3Rzd2FwTW9ja1Nka1Byb3ZpZGVyO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gc2V0dXBIb3Rzd2FwTmVzdGVkU3RhY2tUZXN0cyhyb290U3RhY2tOYW1lOiBzdHJpbmcpIHtcbiAgamVzdC5yZXNldEFsbE1vY2tzKCk7XG4gIGN1cnJlbnROZXN0ZWRDZm5TdGFja1Jlc291cmNlcyA9IHt9O1xuICBob3Rzd2FwTW9ja1Nka1Byb3ZpZGVyID0gbmV3IEhvdHN3YXBNb2NrU2RrUHJvdmlkZXIocm9vdFN0YWNrTmFtZSk7XG4gIGN1cnJlbnRDZm5TdGFjayA9IG5ldyBGYWtlQ2xvdWRmb3JtYXRpb25TdGFjayh7XG4gICAgc3RhY2tOYW1lOiByb290U3RhY2tOYW1lLFxuICAgIHN0YWNrSWQ6IFNUQUNLX0lELFxuICB9KTtcbiAgc3RhY2tUZW1wbGF0ZXMgPSB7fTtcbiAgQ2xvdWRGb3JtYXRpb25TdGFjay5sb29rdXAgPSBhc3luYyAoXzogQVdTLkNsb3VkRm9ybWF0aW9uLCBzdGFja05hbWU6IHN0cmluZykgPT4ge1xuICAgIGN1cnJlbnRDZm5TdGFjay50ZW1wbGF0ZSA9IGFzeW5jICgpID0+IHN0YWNrVGVtcGxhdGVzW3N0YWNrTmFtZV07XG4gICAgcmV0dXJuIGN1cnJlbnRDZm5TdGFjaztcbiAgfTtcblxuICByZXR1cm4gaG90c3dhcE1vY2tTZGtQcm92aWRlcjtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGNka1N0YWNrQXJ0aWZhY3RPZih0ZXN0U3RhY2tBcnRpZmFjdDogUGFydGlhbDxUZXN0U3RhY2tBcnRpZmFjdD4gPSB7fSk6IGN4YXBpLkNsb3VkRm9ybWF0aW9uU3RhY2tBcnRpZmFjdCB7XG4gIHJldHVybiB0ZXN0U3RhY2soe1xuICAgIHN0YWNrTmFtZTogU1RBQ0tfTkFNRSxcbiAgICAuLi50ZXN0U3RhY2tBcnRpZmFjdCxcbiAgfSk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBwdXNoU3RhY2tSZXNvdXJjZVN1bW1hcmllcyguLi5pdGVtczogQVdTLkNsb3VkRm9ybWF0aW9uLlN0YWNrUmVzb3VyY2VTdW1tYXJ5W10pIHtcbiAgY3VycmVudENmblN0YWNrUmVzb3VyY2VzLnB1c2goLi4uaXRlbXMpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gcHVzaE5lc3RlZFN0YWNrUmVzb3VyY2VTdW1tYXJpZXMoc3RhY2tOYW1lOiBzdHJpbmcsIC4uLml0ZW1zOiBBV1MuQ2xvdWRGb3JtYXRpb24uU3RhY2tSZXNvdXJjZVN1bW1hcnlbXSkge1xuICBpZiAoIWN1cnJlbnROZXN0ZWRDZm5TdGFja1Jlc291cmNlc1tzdGFja05hbWVdKSB7XG4gICAgY3VycmVudE5lc3RlZENmblN0YWNrUmVzb3VyY2VzW3N0YWNrTmFtZV0gPSBbXTtcbiAgfVxuICBjdXJyZW50TmVzdGVkQ2ZuU3RhY2tSZXNvdXJjZXNbc3RhY2tOYW1lXS5wdXNoKC4uLml0ZW1zKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHNldEN1cnJlbnRDZm5TdGFja1RlbXBsYXRlKHRlbXBsYXRlOiBUZW1wbGF0ZSkge1xuICBjb25zdCB0ZW1wbGF0ZURlZXBDb3B5ID0gSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeSh0ZW1wbGF0ZSkpOyAvLyBkZWVwIGNvcHkgdGhlIHRlbXBsYXRlLCBzbyBvdXIgdGVzdHMgY2FuIG11dGF0ZSBvbmUgdGVtcGxhdGUgaW5zdGVhZCBvZiBjcmVhdGluZyB0d29cbiAgY3VycmVudENmblN0YWNrLnNldFRlbXBsYXRlKHRlbXBsYXRlRGVlcENvcHkpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gYWRkVGVtcGxhdGVUb0Nsb3VkRm9ybWF0aW9uTG9va3VwTW9jayhzdGFja0FydGlmYWN0OiBjeGFwaS5DbG91ZEZvcm1hdGlvblN0YWNrQXJ0aWZhY3QpIHtcbiAgY29uc3QgdGVtcGxhdGVEZWVwQ29weSA9IEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkoc3RhY2tBcnRpZmFjdC50ZW1wbGF0ZSkpOyAvLyBkZWVwIGNvcHkgdGhlIHRlbXBsYXRlLCBzbyBvdXIgdGVzdHMgY2FuIG11dGF0ZSBvbmUgdGVtcGxhdGUgaW5zdGVhZCBvZiBjcmVhdGluZyB0d29cbiAgc3RhY2tUZW1wbGF0ZXNbc3RhY2tBcnRpZmFjdC5zdGFja05hbWVdID0gdGVtcGxhdGVEZWVwQ29weTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHN0YWNrU3VtbWFyeU9mKGxvZ2ljYWxJZDogc3RyaW5nLCByZXNvdXJjZVR5cGU6IHN0cmluZywgcGh5c2ljYWxSZXNvdXJjZUlkOiBzdHJpbmcpOiBBV1MuQ2xvdWRGb3JtYXRpb24uU3RhY2tSZXNvdXJjZVN1bW1hcnkge1xuICByZXR1cm4ge1xuICAgIExvZ2ljYWxSZXNvdXJjZUlkOiBsb2dpY2FsSWQsXG4gICAgUGh5c2ljYWxSZXNvdXJjZUlkOiBwaHlzaWNhbFJlc291cmNlSWQsXG4gICAgUmVzb3VyY2VUeXBlOiByZXNvdXJjZVR5cGUsXG4gICAgUmVzb3VyY2VTdGF0dXM6ICdDUkVBVEVfQ09NUExFVEUnLFxuICAgIExhc3RVcGRhdGVkVGltZXN0YW1wOiBuZXcgRGF0ZSgpLFxuICB9O1xufVxuXG5leHBvcnQgY2xhc3MgSG90c3dhcE1vY2tTZGtQcm92aWRlciB7XG4gIHB1YmxpYyByZWFkb25seSBtb2NrU2RrUHJvdmlkZXI6IE1vY2tTZGtQcm92aWRlcjtcblxuICBjb25zdHJ1Y3Rvcihyb290U3RhY2tOYW1lPzogc3RyaW5nKSB7XG4gICAgdGhpcy5tb2NrU2RrUHJvdmlkZXIgPSBuZXcgTW9ja1Nka1Byb3ZpZGVyKHsgcmVhbFNkazogZmFsc2UgfSk7XG5cbiAgICB0aGlzLm1vY2tTZGtQcm92aWRlci5zdHViQ2xvdWRGb3JtYXRpb24oe1xuICAgICAgbGlzdFN0YWNrUmVzb3VyY2VzOiAoeyBTdGFja05hbWU6IHN0YWNrTmFtZSB9KSA9PiB7XG4gICAgICAgIGlmIChyb290U3RhY2tOYW1lKSB7XG4gICAgICAgICAgY29uc3Qga25vd25TdGFja05hbWVzID0gT2JqZWN0LmtleXMoY3VycmVudE5lc3RlZENmblN0YWNrUmVzb3VyY2VzKTtcbiAgICAgICAgICBpZiAoc3RhY2tOYW1lICE9PSByb290U3RhY2tOYW1lICYmICFrbm93blN0YWNrTmFtZXMuaW5jbHVkZXMoc3RhY2tOYW1lKSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBFeHBlY3RlZCBTdGFjayBuYW1lIGluIGxpc3RTdGFja1Jlc291cmNlcygpIGNhbGwgdG8gYmUgYSBtZW1iZXIgb2YgWycke3Jvb3RTdGFja05hbWV9LCAke2tub3duU3RhY2tOYW1lc30nXSwgYnV0IHJlY2VpdmVkOiAnJHtzdGFja05hbWV9J2ApO1xuICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIGlmIChzdGFja05hbWUgIT09IFNUQUNLX05BTUUpIHtcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEV4cGVjdGVkIFN0YWNrIG5hbWUgaW4gbGlzdFN0YWNrUmVzb3VyY2VzKCkgY2FsbCB0byBiZTogJyR7U1RBQ0tfTkFNRX0nLCBidXQgcmVjZWl2ZWQ6ICcke3N0YWNrTmFtZX0nYCk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBTdGFja1Jlc291cmNlU3VtbWFyaWVzOiByb290U3RhY2tOYW1lID8gY3VycmVudE5lc3RlZENmblN0YWNrUmVzb3VyY2VzW3N0YWNrTmFtZV0gOiBjdXJyZW50Q2ZuU3RhY2tSZXNvdXJjZXMsXG4gICAgICAgIH07XG4gICAgICB9LFxuICAgIH0pO1xuICB9XG5cbiAgcHVibGljIHNldFVwZGF0ZVN0YXRlTWFjaGluZU1vY2soXG4gICAgbW9ja1VwZGF0ZU1hY2hpbmVEZWZpbml0aW9uOiAoaW5wdXQ6IHN0ZXBmdW5jdGlvbnMuVXBkYXRlU3RhdGVNYWNoaW5lSW5wdXQpID0+IHN0ZXBmdW5jdGlvbnMuVXBkYXRlU3RhdGVNYWNoaW5lT3V0cHV0LFxuICApIHtcbiAgICB0aGlzLm1vY2tTZGtQcm92aWRlci5zdHViU3RlcEZ1bmN0aW9ucyh7XG4gICAgICB1cGRhdGVTdGF0ZU1hY2hpbmU6IG1vY2tVcGRhdGVNYWNoaW5lRGVmaW5pdGlvbixcbiAgICB9KTtcbiAgfVxuXG4gIHB1YmxpYyBzdHViTGFtYmRhKFxuICAgIHN0dWJzOiBTeW5jSGFuZGxlclN1YnNldE9mPEFXUy5MYW1iZGE+LFxuICAgIHNlcnZpY2VTdHVicz86IFN5bmNIYW5kbGVyU3Vic2V0T2Y8QVdTLlNlcnZpY2U+LFxuICAgIGFkZGl0aW9uYWxQcm9wZXJ0aWVzOiB7IFtrZXk6IHN0cmluZ106IGFueSB9ID0ge30sXG4gICk6IHZvaWQge1xuICAgIHRoaXMubW9ja1Nka1Byb3ZpZGVyLnN0dWJMYW1iZGEoc3R1YnMsIHtcbiAgICAgIGFwaToge1xuICAgICAgICB3YWl0ZXJzOiB7fSxcbiAgICAgIH0sXG4gICAgICBtYWtlUmVxdWVzdCgpIHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBwcm9taXNlOiAoKSA9PiBQcm9taXNlLnJlc29sdmUoe30pLFxuICAgICAgICAgIHJlc3BvbnNlOiB7fSxcbiAgICAgICAgICBhZGRMaXN0ZW5lcnM6ICgpID0+IHt9LFxuICAgICAgICB9O1xuICAgICAgfSxcbiAgICAgIC4uLnNlcnZpY2VTdHVicyxcbiAgICAgIC4uLmFkZGl0aW9uYWxQcm9wZXJ0aWVzLFxuICAgIH0pO1xuICB9XG5cbiAgcHVibGljIGdldExhbWJkYUFwaVdhaXRlcnMoKTogeyBba2V5OiBzdHJpbmddOiBhbnkgfSB7XG4gICAgcmV0dXJuICh0aGlzLm1vY2tTZGtQcm92aWRlci5zZGsubGFtYmRhKCkgYXMgYW55KS5hcGkud2FpdGVycztcbiAgfVxuXG4gIHB1YmxpYyBzZXRVcGRhdGVQcm9qZWN0TW9jayhtb2NrVXBkYXRlUHJvamVjdDogKGlucHV0OiBjb2RlYnVpbGQuVXBkYXRlUHJvamVjdElucHV0KSA9PiBjb2RlYnVpbGQuVXBkYXRlUHJvamVjdE91dHB1dCkge1xuICAgIHRoaXMubW9ja1Nka1Byb3ZpZGVyLnN0dWJDb2RlQnVpbGQoe1xuICAgICAgdXBkYXRlUHJvamVjdDogbW9ja1VwZGF0ZVByb2plY3QsXG4gICAgfSk7XG4gIH1cblxuICBwdWJsaWMgc3R1YkFwcFN5bmMoc3R1YnM6IFN5bmNIYW5kbGVyU3Vic2V0T2Y8QVdTLkFwcFN5bmM+KSB7XG4gICAgdGhpcy5tb2NrU2RrUHJvdmlkZXIuc3R1YkFwcFN5bmMoc3R1YnMpO1xuICB9XG5cbiAgcHVibGljIHNldEludm9rZUxhbWJkYU1vY2sobW9ja0ludm9rZUxhbWJkYTogKGlucHV0OiBsYW1iZGEuSW52b2NhdGlvblJlcXVlc3QpID0+IGxhbWJkYS5JbnZvY2F0aW9uUmVzcG9uc2UpIHtcbiAgICB0aGlzLm1vY2tTZGtQcm92aWRlci5zdHViTGFtYmRhKHtcbiAgICAgIGludm9rZTogbW9ja0ludm9rZUxhbWJkYSxcbiAgICB9KTtcbiAgfVxuXG4gIHB1YmxpYyBzdHViRWNzKHN0dWJzOiBTeW5jSGFuZGxlclN1YnNldE9mPEFXUy5FQ1M+LCBhZGRpdGlvbmFsUHJvcGVydGllczogeyBba2V5OiBzdHJpbmddOiBhbnkgfSA9IHt9KTogdm9pZCB7XG4gICAgdGhpcy5tb2NrU2RrUHJvdmlkZXIuc3R1YkVjcyhzdHVicywgYWRkaXRpb25hbFByb3BlcnRpZXMpO1xuICB9XG5cbiAgcHVibGljIHN0dWJHZXRFbmRwb2ludFN1ZmZpeChzdHViOiAoKSA9PiBzdHJpbmcpIHtcbiAgICB0aGlzLm1vY2tTZGtQcm92aWRlci5zdHViR2V0RW5kcG9pbnRTdWZmaXgoc3R1Yik7XG4gIH1cblxuICBwdWJsaWMgc3R1YlMzKHN0dWJzOiBTeW5jSGFuZGxlclN1YnNldE9mPEFXUy5TMz4pIHtcbiAgICB0aGlzLm1vY2tTZGtQcm92aWRlci5zdHViUzMoc3R1YnMpO1xuICB9XG5cbiAgcHVibGljIHRyeUhvdHN3YXBEZXBsb3ltZW50KFxuICAgIGhvdHN3YXBNb2RlOiBIb3Rzd2FwTW9kZSxcbiAgICBzdGFja0FydGlmYWN0OiBjeGFwaS5DbG91ZEZvcm1hdGlvblN0YWNrQXJ0aWZhY3QsXG4gICAgYXNzZXRQYXJhbXM6IHsgW2tleTogc3RyaW5nXTogc3RyaW5nIH0gPSB7fSxcbiAgICBob3Rzd2FwUHJvcGVydHlPdmVycmlkZXM/OiBIb3Rzd2FwUHJvcGVydHlPdmVycmlkZXMsXG4gICk6IFByb21pc2U8RGVwbG95U3RhY2tSZXN1bHQgfCB1bmRlZmluZWQ+IHtcbiAgICBsZXQgaG90c3dhcFByb3BzID0gaG90c3dhcFByb3BlcnR5T3ZlcnJpZGVzIHx8IG5ldyBIb3Rzd2FwUHJvcGVydHlPdmVycmlkZXMoKTtcbiAgICByZXR1cm4gZGVwbG95bWVudHMudHJ5SG90c3dhcERlcGxveW1lbnQodGhpcy5tb2NrU2RrUHJvdmlkZXIsIGFzc2V0UGFyYW1zLCBjdXJyZW50Q2ZuU3RhY2ssIHN0YWNrQXJ0aWZhY3QsIGhvdHN3YXBNb2RlLCBob3Rzd2FwUHJvcHMpO1xuICB9XG59XG4iXX0=