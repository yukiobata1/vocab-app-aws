"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const AWS = require("aws-sdk");
const AWSMock = require("aws-sdk-mock");
const checks_1 = require("../../../lib/api/util/checks");
describe('determineAllowCrossAccountAssetPublishing', () => {
    let mockSDK;
    beforeEach(() => {
        mockSDK = {
            cloudFormation: () => new AWS.CloudFormation(),
        };
    });
    afterEach(() => {
        AWSMock.restore();
    });
    it('should return true when hasStagingBucket is false', async () => {
        AWSMock.mock('CloudFormation', 'describeStacks', (_params, callback) => {
            callback(null, {
                Stacks: [{
                        Outputs: [{ OutputKey: 'BootstrapVersion', OutputValue: '1' }],
                    }],
            });
        });
        const result = await (0, checks_1.determineAllowCrossAccountAssetPublishing)(mockSDK);
        expect(result).toBe(true);
    });
    it.each(['', '-', '*', '---'])('should return true when the bucket output does not look like a real bucket', async (notABucketName) => {
        AWSMock.mock('CloudFormation', 'describeStacks', (_params, callback) => {
            callback(null, {
                Stacks: [{
                        Outputs: [
                            { OutputKey: 'BootstrapVersion', OutputValue: '1' },
                            { OutputKey: 'BucketName', OutputValue: notABucketName },
                        ],
                    }],
            });
        });
        const result = await (0, checks_1.determineAllowCrossAccountAssetPublishing)(mockSDK);
        expect(result).toBe(true);
    });
    it('should return true when bootstrap version is >= 21', async () => {
        AWSMock.mock('CloudFormation', 'describeStacks', (_params, callback) => {
            callback(null, {
                Stacks: [{
                        Outputs: [
                            { OutputKey: 'BootstrapVersion', OutputValue: '21' },
                            { OutputKey: 'BucketName', OutputValue: 'some-bucket' },
                        ],
                    }],
            });
        });
        const result = await (0, checks_1.determineAllowCrossAccountAssetPublishing)(mockSDK);
        expect(result).toBe(true);
    });
    it('should return true if looking up the bootstrap stack fails', async () => {
        AWSMock.mock('CloudFormation', 'describeStacks', (_params, callback) => {
            callback(new Error('Could not read bootstrap stack'));
        });
        const result = await (0, checks_1.determineAllowCrossAccountAssetPublishing)(mockSDK);
        expect(result).toBe(true);
    });
    it('should return true if looking up the bootstrap stack fails', async () => {
        AWSMock.mock('CloudFormation', 'describeStacks', (_params, callback) => {
            callback(new Error('Could not read bootstrap stack'));
        });
        const result = await (0, checks_1.determineAllowCrossAccountAssetPublishing)(mockSDK);
        expect(result).toBe(true);
    });
    it('should return false for other scenarios', async () => {
        AWSMock.mock('CloudFormation', 'describeStacks', (_params, callback) => {
            callback(null, {
                Stacks: [{
                        Outputs: [
                            { OutputKey: 'BootstrapVersion', OutputValue: '20' },
                            { OutputKey: 'BucketName', OutputValue: 'some-bucket' },
                        ],
                    }],
            });
        });
        const result = await (0, checks_1.determineAllowCrossAccountAssetPublishing)(mockSDK);
        expect(result).toBe(false);
    });
});
describe('getBootstrapStackInfo', () => {
    let mockSDK;
    beforeEach(() => {
        mockSDK = {
            cloudFormation: () => new AWS.CloudFormation(),
        };
    });
    afterEach(() => {
        AWSMock.restore();
    });
    it('should return correct BootstrapStackInfo', async () => {
        AWSMock.mock('CloudFormation', 'describeStacks', (_params, callback) => {
            callback(null, {
                Stacks: [{
                        Outputs: [
                            { OutputKey: 'BootstrapVersion', OutputValue: '21' },
                            { OutputKey: 'BucketName', OutputValue: 'some-bucket' },
                        ],
                    }],
            });
        });
        const result = await (0, checks_1.getBootstrapStackInfo)(mockSDK, 'CDKToolkit');
        expect(result).toEqual({
            hasStagingBucket: true,
            bootstrapVersion: 21,
        });
    });
    it('should throw error when stack is not found', async () => {
        AWSMock.mock('CloudFormation', 'describeStacks', (_params, callback) => {
            callback(null, { Stacks: [] });
        });
        await expect((0, checks_1.getBootstrapStackInfo)(mockSDK, 'CDKToolkit')).rejects.toThrow('Toolkit stack CDKToolkit not found');
    });
    it('should throw error when BootstrapVersion output is missing', async () => {
        AWSMock.mock('CloudFormation', 'describeStacks', (_params, callback) => {
            callback(null, {
                Stacks: [{
                        Outputs: [],
                    }],
            });
        });
        await expect((0, checks_1.getBootstrapStackInfo)(mockSDK, 'CDKToolkit')).rejects.toThrow('Unable to find BootstrapVersion output in the toolkit stack CDKToolkit');
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2hlY2tzLnRlc3QuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJjaGVja3MudGVzdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLCtCQUErQjtBQUMvQix3Q0FBd0M7QUFFeEMseURBQWdIO0FBRWhILFFBQVEsQ0FBQywyQ0FBMkMsRUFBRSxHQUFHLEVBQUU7SUFDekQsSUFBSSxPQUFhLENBQUM7SUFFbEIsVUFBVSxDQUFDLEdBQUcsRUFBRTtRQUNkLE9BQU8sR0FBRztZQUNSLGNBQWMsRUFBRSxHQUFHLEVBQUUsQ0FBQyxJQUFJLEdBQUcsQ0FBQyxjQUFjLEVBQUU7U0FDdkMsQ0FBQztJQUNaLENBQUMsQ0FBQyxDQUFDO0lBRUgsU0FBUyxDQUFDLEdBQUcsRUFBRTtRQUNiLE9BQU8sQ0FBQyxPQUFPLEVBQUUsQ0FBQztJQUNwQixDQUFDLENBQUMsQ0FBQztJQUVILEVBQUUsQ0FBQyxtREFBbUQsRUFBRSxLQUFLLElBQUksRUFBRTtRQUNqRSxPQUFPLENBQUMsSUFBSSxDQUFDLGdCQUFnQixFQUFFLGdCQUFnQixFQUFFLENBQUMsT0FBWSxFQUFFLFFBQWtCLEVBQUUsRUFBRTtZQUNwRixRQUFRLENBQUMsSUFBSSxFQUFFO2dCQUNiLE1BQU0sRUFBRSxDQUFDO3dCQUNQLE9BQU8sRUFBRSxDQUFDLEVBQUUsU0FBUyxFQUFFLGtCQUFrQixFQUFFLFdBQVcsRUFBRSxHQUFHLEVBQUUsQ0FBQztxQkFDL0QsQ0FBQzthQUNILENBQUMsQ0FBQztRQUNMLENBQUMsQ0FBQyxDQUFDO1FBRUgsTUFBTSxNQUFNLEdBQUcsTUFBTSxJQUFBLGtEQUF5QyxFQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQ3hFLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDNUIsQ0FBQyxDQUFDLENBQUM7SUFFSCxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUMsRUFBRSxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsS0FBSyxDQUFDLENBQUMsQ0FBQyw0RUFBNEUsRUFBRSxLQUFLLEVBQUUsY0FBYyxFQUFFLEVBQUU7UUFDcEksT0FBTyxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsRUFBRSxnQkFBZ0IsRUFBRSxDQUFDLE9BQVksRUFBRSxRQUFrQixFQUFFLEVBQUU7WUFDcEYsUUFBUSxDQUFDLElBQUksRUFBRTtnQkFDYixNQUFNLEVBQUUsQ0FBQzt3QkFDUCxPQUFPLEVBQUU7NEJBQ1AsRUFBRSxTQUFTLEVBQUUsa0JBQWtCLEVBQUUsV0FBVyxFQUFFLEdBQUcsRUFBRTs0QkFDbkQsRUFBRSxTQUFTLEVBQUUsWUFBWSxFQUFFLFdBQVcsRUFBRSxjQUFjLEVBQUU7eUJBQ3pEO3FCQUNGLENBQUM7YUFDSCxDQUFDLENBQUM7UUFDTCxDQUFDLENBQUMsQ0FBQztRQUVILE1BQU0sTUFBTSxHQUFHLE1BQU0sSUFBQSxrREFBeUMsRUFBQyxPQUFPLENBQUMsQ0FBQztRQUN4RSxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQzVCLENBQUMsQ0FBQyxDQUFDO0lBRUgsRUFBRSxDQUFDLG9EQUFvRCxFQUFFLEtBQUssSUFBSSxFQUFFO1FBQ2xFLE9BQU8sQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLEVBQUUsZ0JBQWdCLEVBQUUsQ0FBQyxPQUFZLEVBQUUsUUFBa0IsRUFBRSxFQUFFO1lBQ3BGLFFBQVEsQ0FBQyxJQUFJLEVBQUU7Z0JBQ2IsTUFBTSxFQUFFLENBQUM7d0JBQ1AsT0FBTyxFQUFFOzRCQUNQLEVBQUUsU0FBUyxFQUFFLGtCQUFrQixFQUFFLFdBQVcsRUFBRSxJQUFJLEVBQUU7NEJBQ3BELEVBQUUsU0FBUyxFQUFFLFlBQVksRUFBRSxXQUFXLEVBQUUsYUFBYSxFQUFFO3lCQUN4RDtxQkFDRixDQUFDO2FBQ0gsQ0FBQyxDQUFDO1FBQ0wsQ0FBQyxDQUFDLENBQUM7UUFFSCxNQUFNLE1BQU0sR0FBRyxNQUFNLElBQUEsa0RBQXlDLEVBQUMsT0FBTyxDQUFDLENBQUM7UUFDeEUsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUM1QixDQUFDLENBQUMsQ0FBQztJQUVILEVBQUUsQ0FBQyw0REFBNEQsRUFBRSxLQUFLLElBQUksRUFBRTtRQUMxRSxPQUFPLENBQUMsSUFBSSxDQUFDLGdCQUFnQixFQUFFLGdCQUFnQixFQUFFLENBQUMsT0FBWSxFQUFFLFFBQWtCLEVBQUUsRUFBRTtZQUNwRixRQUFRLENBQUMsSUFBSSxLQUFLLENBQUMsZ0NBQWdDLENBQUMsQ0FBQyxDQUFDO1FBQ3hELENBQUMsQ0FBQyxDQUFDO1FBRUgsTUFBTSxNQUFNLEdBQUcsTUFBTSxJQUFBLGtEQUF5QyxFQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQ3hFLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDNUIsQ0FBQyxDQUFDLENBQUM7SUFFSCxFQUFFLENBQUMsNERBQTRELEVBQUUsS0FBSyxJQUFJLEVBQUU7UUFDMUUsT0FBTyxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsRUFBRSxnQkFBZ0IsRUFBRSxDQUFDLE9BQVksRUFBRSxRQUFrQixFQUFFLEVBQUU7WUFDcEYsUUFBUSxDQUFDLElBQUksS0FBSyxDQUFDLGdDQUFnQyxDQUFDLENBQUMsQ0FBQztRQUN4RCxDQUFDLENBQUMsQ0FBQztRQUVILE1BQU0sTUFBTSxHQUFHLE1BQU0sSUFBQSxrREFBeUMsRUFBQyxPQUFPLENBQUMsQ0FBQztRQUN4RSxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQzVCLENBQUMsQ0FBQyxDQUFDO0lBRUgsRUFBRSxDQUFDLHlDQUF5QyxFQUFFLEtBQUssSUFBSSxFQUFFO1FBQ3ZELE9BQU8sQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLEVBQUUsZ0JBQWdCLEVBQUUsQ0FBQyxPQUFZLEVBQUUsUUFBa0IsRUFBRSxFQUFFO1lBQ3BGLFFBQVEsQ0FBQyxJQUFJLEVBQUU7Z0JBQ2IsTUFBTSxFQUFFLENBQUM7d0JBQ1AsT0FBTyxFQUFFOzRCQUNQLEVBQUUsU0FBUyxFQUFFLGtCQUFrQixFQUFFLFdBQVcsRUFBRSxJQUFJLEVBQUU7NEJBQ3BELEVBQUUsU0FBUyxFQUFFLFlBQVksRUFBRSxXQUFXLEVBQUUsYUFBYSxFQUFFO3lCQUN4RDtxQkFDRixDQUFDO2FBQ0gsQ0FBQyxDQUFDO1FBQ0wsQ0FBQyxDQUFDLENBQUM7UUFFSCxNQUFNLE1BQU0sR0FBRyxNQUFNLElBQUEsa0RBQXlDLEVBQUMsT0FBTyxDQUFDLENBQUM7UUFDeEUsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUM3QixDQUFDLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQyxDQUFDO0FBRUgsUUFBUSxDQUFDLHVCQUF1QixFQUFFLEdBQUcsRUFBRTtJQUNyQyxJQUFJLE9BQWEsQ0FBQztJQUVsQixVQUFVLENBQUMsR0FBRyxFQUFFO1FBQ2QsT0FBTyxHQUFHO1lBQ1IsY0FBYyxFQUFFLEdBQUcsRUFBRSxDQUFDLElBQUksR0FBRyxDQUFDLGNBQWMsRUFBRTtTQUN2QyxDQUFDO0lBQ1osQ0FBQyxDQUFDLENBQUM7SUFFSCxTQUFTLENBQUMsR0FBRyxFQUFFO1FBQ2IsT0FBTyxDQUFDLE9BQU8sRUFBRSxDQUFDO0lBQ3BCLENBQUMsQ0FBQyxDQUFDO0lBRUgsRUFBRSxDQUFDLDBDQUEwQyxFQUFFLEtBQUssSUFBSSxFQUFFO1FBQ3hELE9BQU8sQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLEVBQUUsZ0JBQWdCLEVBQUUsQ0FBQyxPQUFZLEVBQUUsUUFBa0IsRUFBRSxFQUFFO1lBQ3BGLFFBQVEsQ0FBQyxJQUFJLEVBQUU7Z0JBQ2IsTUFBTSxFQUFFLENBQUM7d0JBQ1AsT0FBTyxFQUFFOzRCQUNQLEVBQUUsU0FBUyxFQUFFLGtCQUFrQixFQUFFLFdBQVcsRUFBRSxJQUFJLEVBQUU7NEJBQ3BELEVBQUUsU0FBUyxFQUFFLFlBQVksRUFBRSxXQUFXLEVBQUUsYUFBYSxFQUFFO3lCQUN4RDtxQkFDRixDQUFDO2FBQ0gsQ0FBQyxDQUFDO1FBQ0wsQ0FBQyxDQUFDLENBQUM7UUFFSCxNQUFNLE1BQU0sR0FBRyxNQUFNLElBQUEsOEJBQXFCLEVBQUMsT0FBTyxFQUFFLFlBQVksQ0FBQyxDQUFDO1FBQ2xFLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxPQUFPLENBQUM7WUFDckIsZ0JBQWdCLEVBQUUsSUFBSTtZQUN0QixnQkFBZ0IsRUFBRSxFQUFFO1NBQ3JCLENBQUMsQ0FBQztJQUNMLENBQUMsQ0FBQyxDQUFDO0lBRUgsRUFBRSxDQUFDLDRDQUE0QyxFQUFFLEtBQUssSUFBSSxFQUFFO1FBQzFELE9BQU8sQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLEVBQUUsZ0JBQWdCLEVBQUUsQ0FBQyxPQUFZLEVBQUUsUUFBa0IsRUFBRSxFQUFFO1lBQ3BGLFFBQVEsQ0FBQyxJQUFJLEVBQUUsRUFBRSxNQUFNLEVBQUUsRUFBRSxFQUFFLENBQUMsQ0FBQztRQUNqQyxDQUFDLENBQUMsQ0FBQztRQUVILE1BQU0sTUFBTSxDQUFDLElBQUEsOEJBQXFCLEVBQUMsT0FBTyxFQUFFLFlBQVksQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxvQ0FBb0MsQ0FBQyxDQUFDO0lBQ25ILENBQUMsQ0FBQyxDQUFDO0lBRUgsRUFBRSxDQUFDLDREQUE0RCxFQUFFLEtBQUssSUFBSSxFQUFFO1FBQzFFLE9BQU8sQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLEVBQUUsZ0JBQWdCLEVBQUUsQ0FBQyxPQUFZLEVBQUUsUUFBa0IsRUFBRSxFQUFFO1lBQ3BGLFFBQVEsQ0FBQyxJQUFJLEVBQUU7Z0JBQ2IsTUFBTSxFQUFFLENBQUM7d0JBQ1AsT0FBTyxFQUFFLEVBQUU7cUJBQ1osQ0FBQzthQUNILENBQUMsQ0FBQztRQUNMLENBQUMsQ0FBQyxDQUFDO1FBRUgsTUFBTSxNQUFNLENBQUMsSUFBQSw4QkFBcUIsRUFBQyxPQUFPLEVBQUUsWUFBWSxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLHdFQUF3RSxDQUFDLENBQUM7SUFDdkosQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIEFXUyBmcm9tICdhd3Mtc2RrJztcbmltcG9ydCAqIGFzIEFXU01vY2sgZnJvbSAnYXdzLXNkay1tb2NrJztcbmltcG9ydCB7IElTREsgfSBmcm9tICcuLi8uLi8uLi9saWIvYXBpL2F3cy1hdXRoJztcbmltcG9ydCB7IGRldGVybWluZUFsbG93Q3Jvc3NBY2NvdW50QXNzZXRQdWJsaXNoaW5nLCBnZXRCb290c3RyYXBTdGFja0luZm8gfSBmcm9tICcuLi8uLi8uLi9saWIvYXBpL3V0aWwvY2hlY2tzJztcblxuZGVzY3JpYmUoJ2RldGVybWluZUFsbG93Q3Jvc3NBY2NvdW50QXNzZXRQdWJsaXNoaW5nJywgKCkgPT4ge1xuICBsZXQgbW9ja1NESzogSVNESztcblxuICBiZWZvcmVFYWNoKCgpID0+IHtcbiAgICBtb2NrU0RLID0ge1xuICAgICAgY2xvdWRGb3JtYXRpb246ICgpID0+IG5ldyBBV1MuQ2xvdWRGb3JtYXRpb24oKSxcbiAgICB9IGFzIElTREs7XG4gIH0pO1xuXG4gIGFmdGVyRWFjaCgoKSA9PiB7XG4gICAgQVdTTW9jay5yZXN0b3JlKCk7XG4gIH0pO1xuXG4gIGl0KCdzaG91bGQgcmV0dXJuIHRydWUgd2hlbiBoYXNTdGFnaW5nQnVja2V0IGlzIGZhbHNlJywgYXN5bmMgKCkgPT4ge1xuICAgIEFXU01vY2subW9jaygnQ2xvdWRGb3JtYXRpb24nLCAnZGVzY3JpYmVTdGFja3MnLCAoX3BhcmFtczogYW55LCBjYWxsYmFjazogRnVuY3Rpb24pID0+IHtcbiAgICAgIGNhbGxiYWNrKG51bGwsIHtcbiAgICAgICAgU3RhY2tzOiBbe1xuICAgICAgICAgIE91dHB1dHM6IFt7IE91dHB1dEtleTogJ0Jvb3RzdHJhcFZlcnNpb24nLCBPdXRwdXRWYWx1ZTogJzEnIH1dLFxuICAgICAgICB9XSxcbiAgICAgIH0pO1xuICAgIH0pO1xuXG4gICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgZGV0ZXJtaW5lQWxsb3dDcm9zc0FjY291bnRBc3NldFB1Ymxpc2hpbmcobW9ja1NESyk7XG4gICAgZXhwZWN0KHJlc3VsdCkudG9CZSh0cnVlKTtcbiAgfSk7XG5cbiAgaXQuZWFjaChbJycsICctJywgJyonLCAnLS0tJ10pKCdzaG91bGQgcmV0dXJuIHRydWUgd2hlbiB0aGUgYnVja2V0IG91dHB1dCBkb2VzIG5vdCBsb29rIGxpa2UgYSByZWFsIGJ1Y2tldCcsIGFzeW5jIChub3RBQnVja2V0TmFtZSkgPT4ge1xuICAgIEFXU01vY2subW9jaygnQ2xvdWRGb3JtYXRpb24nLCAnZGVzY3JpYmVTdGFja3MnLCAoX3BhcmFtczogYW55LCBjYWxsYmFjazogRnVuY3Rpb24pID0+IHtcbiAgICAgIGNhbGxiYWNrKG51bGwsIHtcbiAgICAgICAgU3RhY2tzOiBbe1xuICAgICAgICAgIE91dHB1dHM6IFtcbiAgICAgICAgICAgIHsgT3V0cHV0S2V5OiAnQm9vdHN0cmFwVmVyc2lvbicsIE91dHB1dFZhbHVlOiAnMScgfSxcbiAgICAgICAgICAgIHsgT3V0cHV0S2V5OiAnQnVja2V0TmFtZScsIE91dHB1dFZhbHVlOiBub3RBQnVja2V0TmFtZSB9LFxuICAgICAgICAgIF0sXG4gICAgICAgIH1dLFxuICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBkZXRlcm1pbmVBbGxvd0Nyb3NzQWNjb3VudEFzc2V0UHVibGlzaGluZyhtb2NrU0RLKTtcbiAgICBleHBlY3QocmVzdWx0KS50b0JlKHRydWUpO1xuICB9KTtcblxuICBpdCgnc2hvdWxkIHJldHVybiB0cnVlIHdoZW4gYm9vdHN0cmFwIHZlcnNpb24gaXMgPj0gMjEnLCBhc3luYyAoKSA9PiB7XG4gICAgQVdTTW9jay5tb2NrKCdDbG91ZEZvcm1hdGlvbicsICdkZXNjcmliZVN0YWNrcycsIChfcGFyYW1zOiBhbnksIGNhbGxiYWNrOiBGdW5jdGlvbikgPT4ge1xuICAgICAgY2FsbGJhY2sobnVsbCwge1xuICAgICAgICBTdGFja3M6IFt7XG4gICAgICAgICAgT3V0cHV0czogW1xuICAgICAgICAgICAgeyBPdXRwdXRLZXk6ICdCb290c3RyYXBWZXJzaW9uJywgT3V0cHV0VmFsdWU6ICcyMScgfSxcbiAgICAgICAgICAgIHsgT3V0cHV0S2V5OiAnQnVja2V0TmFtZScsIE91dHB1dFZhbHVlOiAnc29tZS1idWNrZXQnIH0sXG4gICAgICAgICAgXSxcbiAgICAgICAgfV0sXG4gICAgICB9KTtcbiAgICB9KTtcblxuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGRldGVybWluZUFsbG93Q3Jvc3NBY2NvdW50QXNzZXRQdWJsaXNoaW5nKG1vY2tTREspO1xuICAgIGV4cGVjdChyZXN1bHQpLnRvQmUodHJ1ZSk7XG4gIH0pO1xuXG4gIGl0KCdzaG91bGQgcmV0dXJuIHRydWUgaWYgbG9va2luZyB1cCB0aGUgYm9vdHN0cmFwIHN0YWNrIGZhaWxzJywgYXN5bmMgKCkgPT4ge1xuICAgIEFXU01vY2subW9jaygnQ2xvdWRGb3JtYXRpb24nLCAnZGVzY3JpYmVTdGFja3MnLCAoX3BhcmFtczogYW55LCBjYWxsYmFjazogRnVuY3Rpb24pID0+IHtcbiAgICAgIGNhbGxiYWNrKG5ldyBFcnJvcignQ291bGQgbm90IHJlYWQgYm9vdHN0cmFwIHN0YWNrJykpO1xuICAgIH0pO1xuXG4gICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgZGV0ZXJtaW5lQWxsb3dDcm9zc0FjY291bnRBc3NldFB1Ymxpc2hpbmcobW9ja1NESyk7XG4gICAgZXhwZWN0KHJlc3VsdCkudG9CZSh0cnVlKTtcbiAgfSk7XG5cbiAgaXQoJ3Nob3VsZCByZXR1cm4gdHJ1ZSBpZiBsb29raW5nIHVwIHRoZSBib290c3RyYXAgc3RhY2sgZmFpbHMnLCBhc3luYyAoKSA9PiB7XG4gICAgQVdTTW9jay5tb2NrKCdDbG91ZEZvcm1hdGlvbicsICdkZXNjcmliZVN0YWNrcycsIChfcGFyYW1zOiBhbnksIGNhbGxiYWNrOiBGdW5jdGlvbikgPT4ge1xuICAgICAgY2FsbGJhY2sobmV3IEVycm9yKCdDb3VsZCBub3QgcmVhZCBib290c3RyYXAgc3RhY2snKSk7XG4gICAgfSk7XG5cbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBkZXRlcm1pbmVBbGxvd0Nyb3NzQWNjb3VudEFzc2V0UHVibGlzaGluZyhtb2NrU0RLKTtcbiAgICBleHBlY3QocmVzdWx0KS50b0JlKHRydWUpO1xuICB9KTtcblxuICBpdCgnc2hvdWxkIHJldHVybiBmYWxzZSBmb3Igb3RoZXIgc2NlbmFyaW9zJywgYXN5bmMgKCkgPT4ge1xuICAgIEFXU01vY2subW9jaygnQ2xvdWRGb3JtYXRpb24nLCAnZGVzY3JpYmVTdGFja3MnLCAoX3BhcmFtczogYW55LCBjYWxsYmFjazogRnVuY3Rpb24pID0+IHtcbiAgICAgIGNhbGxiYWNrKG51bGwsIHtcbiAgICAgICAgU3RhY2tzOiBbe1xuICAgICAgICAgIE91dHB1dHM6IFtcbiAgICAgICAgICAgIHsgT3V0cHV0S2V5OiAnQm9vdHN0cmFwVmVyc2lvbicsIE91dHB1dFZhbHVlOiAnMjAnIH0sXG4gICAgICAgICAgICB7IE91dHB1dEtleTogJ0J1Y2tldE5hbWUnLCBPdXRwdXRWYWx1ZTogJ3NvbWUtYnVja2V0JyB9LFxuICAgICAgICAgIF0sXG4gICAgICAgIH1dLFxuICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBkZXRlcm1pbmVBbGxvd0Nyb3NzQWNjb3VudEFzc2V0UHVibGlzaGluZyhtb2NrU0RLKTtcbiAgICBleHBlY3QocmVzdWx0KS50b0JlKGZhbHNlKTtcbiAgfSk7XG59KTtcblxuZGVzY3JpYmUoJ2dldEJvb3RzdHJhcFN0YWNrSW5mbycsICgpID0+IHtcbiAgbGV0IG1vY2tTREs6IElTREs7XG5cbiAgYmVmb3JlRWFjaCgoKSA9PiB7XG4gICAgbW9ja1NESyA9IHtcbiAgICAgIGNsb3VkRm9ybWF0aW9uOiAoKSA9PiBuZXcgQVdTLkNsb3VkRm9ybWF0aW9uKCksXG4gICAgfSBhcyBJU0RLO1xuICB9KTtcblxuICBhZnRlckVhY2goKCkgPT4ge1xuICAgIEFXU01vY2sucmVzdG9yZSgpO1xuICB9KTtcblxuICBpdCgnc2hvdWxkIHJldHVybiBjb3JyZWN0IEJvb3RzdHJhcFN0YWNrSW5mbycsIGFzeW5jICgpID0+IHtcbiAgICBBV1NNb2NrLm1vY2soJ0Nsb3VkRm9ybWF0aW9uJywgJ2Rlc2NyaWJlU3RhY2tzJywgKF9wYXJhbXM6IGFueSwgY2FsbGJhY2s6IEZ1bmN0aW9uKSA9PiB7XG4gICAgICBjYWxsYmFjayhudWxsLCB7XG4gICAgICAgIFN0YWNrczogW3tcbiAgICAgICAgICBPdXRwdXRzOiBbXG4gICAgICAgICAgICB7IE91dHB1dEtleTogJ0Jvb3RzdHJhcFZlcnNpb24nLCBPdXRwdXRWYWx1ZTogJzIxJyB9LFxuICAgICAgICAgICAgeyBPdXRwdXRLZXk6ICdCdWNrZXROYW1lJywgT3V0cHV0VmFsdWU6ICdzb21lLWJ1Y2tldCcgfSxcbiAgICAgICAgICBdLFxuICAgICAgICB9XSxcbiAgICAgIH0pO1xuICAgIH0pO1xuXG4gICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgZ2V0Qm9vdHN0cmFwU3RhY2tJbmZvKG1vY2tTREssICdDREtUb29sa2l0Jyk7XG4gICAgZXhwZWN0KHJlc3VsdCkudG9FcXVhbCh7XG4gICAgICBoYXNTdGFnaW5nQnVja2V0OiB0cnVlLFxuICAgICAgYm9vdHN0cmFwVmVyc2lvbjogMjEsXG4gICAgfSk7XG4gIH0pO1xuXG4gIGl0KCdzaG91bGQgdGhyb3cgZXJyb3Igd2hlbiBzdGFjayBpcyBub3QgZm91bmQnLCBhc3luYyAoKSA9PiB7XG4gICAgQVdTTW9jay5tb2NrKCdDbG91ZEZvcm1hdGlvbicsICdkZXNjcmliZVN0YWNrcycsIChfcGFyYW1zOiBhbnksIGNhbGxiYWNrOiBGdW5jdGlvbikgPT4ge1xuICAgICAgY2FsbGJhY2sobnVsbCwgeyBTdGFja3M6IFtdIH0pO1xuICAgIH0pO1xuXG4gICAgYXdhaXQgZXhwZWN0KGdldEJvb3RzdHJhcFN0YWNrSW5mbyhtb2NrU0RLLCAnQ0RLVG9vbGtpdCcpKS5yZWplY3RzLnRvVGhyb3coJ1Rvb2xraXQgc3RhY2sgQ0RLVG9vbGtpdCBub3QgZm91bmQnKTtcbiAgfSk7XG5cbiAgaXQoJ3Nob3VsZCB0aHJvdyBlcnJvciB3aGVuIEJvb3RzdHJhcFZlcnNpb24gb3V0cHV0IGlzIG1pc3NpbmcnLCBhc3luYyAoKSA9PiB7XG4gICAgQVdTTW9jay5tb2NrKCdDbG91ZEZvcm1hdGlvbicsICdkZXNjcmliZVN0YWNrcycsIChfcGFyYW1zOiBhbnksIGNhbGxiYWNrOiBGdW5jdGlvbikgPT4ge1xuICAgICAgY2FsbGJhY2sobnVsbCwge1xuICAgICAgICBTdGFja3M6IFt7XG4gICAgICAgICAgT3V0cHV0czogW10sXG4gICAgICAgIH1dLFxuICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICBhd2FpdCBleHBlY3QoZ2V0Qm9vdHN0cmFwU3RhY2tJbmZvKG1vY2tTREssICdDREtUb29sa2l0JykpLnJlamVjdHMudG9UaHJvdygnVW5hYmxlIHRvIGZpbmQgQm9vdHN0cmFwVmVyc2lvbiBvdXRwdXQgaW4gdGhlIHRvb2xraXQgc3RhY2sgQ0RLVG9vbGtpdCcpO1xuICB9KTtcbn0pOyJdfQ==